---
title: "Lab01"
author: "Yalin Yang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: TRUE
    toc_float: TRUE
  word_document:
    toc: no
    toc_depth: '3'
---

```{r}
library(tidyverse)
library(nycflights13)
```


## TASK 1

### a
This is a safe way of comparing if two vectors of floating point numbers are (pairwise) equal. This is safer than using ==, because it has a built in tolerance
```{r}
sqrt(2) ^ 2 == 2
near(sqrt(2) ^ 2, 2)
```

```{r}
.Machine$double.eps^0.5
```

### b

```{r}
data("flights")
```

```{r}
flights %>% filter(arr_delay>=3*60)
```

```{r}
flights %>% filter(dest %in% c('DFW','DAL')) 
```
```{r}
table(flights$dest)
```

```{r}
flights %>% filter(carrier %in% c('WN','AA'))
```


```{r}
flights %>% filter(arr_delay > 2 * 60,(sched_arr_time - sched_dep_time) - air_time  > 30)
```


```{r}
flights %>% filter(dep_delay > 1 * 60,arr_delay > 60 ,(sched_arr_time - sched_dep_time) - air_time  > 30)
```

### c

```{r}
flights %>% arrange(!is.na(flights))
```

### d

```{r}
?select
# everything() selects all variable. It is also useful in combination with other tidyselect operators.
```
```{r}
flights %>% select(sched_arr_time,sched_dep_time,sched_dep_time)
```

### e
* `mutate()` adds new variables and preserves existing ones; `transmute(`) adds new variables and drops existing ones. New variables overwrite existing variables of the same name. Variables can be removed by setting their value to NULL.

```{r}
??mutate

```

### f

```{r}
flights %>% filter(!is.na(arr_delay)) %>% 
  mutate(ranking = rank(arr_delay, ties.method = "min")) %>% 
  top_n(10)
```
```{r}
flights %>% filter(!is.na(arr_delay)) %>% 
  mutate(ranking = min_rank(arr_delay)) %>% 
  top_n(10)
```

### g
```{r}
flights %>% group_by(carrier) %>% 
  summarise(avg_dep_delay = mean(dep_delay[!is.na(dep_delay)]),
            avg_arr_delay = mean(arr_delay[!is.na(arr_delay)]))  
```

### h

```{r}
flights %>% filter(dep_delay > 0) %>% 
  group_by(hour) %>% 
  summarise(avg_delay = mean(dep_delay),happend_times =n())
```


### Task 2

```{r}
# w %>% x %>% y %>% z
```


## Task 3

```{r}
## Data manipulation and visualization
library(dplyr); library(ggplot2); library(gmodels)  
## Modeling process packages
library(caret)     # for resampling and model training
library(rsample)   # splitting the data into training and test datasets
```

### a

```{r}
credit <-read.csv("credit.csv", header = TRUE, stringsAsFactors = TRUE)
sapply(credit, is.factor)
```

```{r}
# Stratified sampling with the rsample package
set.seed(123)
split <- initial_split(credit, prop = 0.7, 
                       strata = "default")
default_train  <- training(split)
default_test   <- testing(split)
```

```{r}
# Specify resampling strategy
cv <- trainControl(
  method = "repeatedcv", 
  number = 10, 
  repeats = 5
)
```

```{r}
# Create grid of hyperparameter values
hyper_grid <- expand.grid(k = seq(30, 80, by = 1))

# Tune a knn model using grid search
knn_fit <- train(
  default ~ . , 
  data = default_train, 
  method = "knn", 
  trControl = cv, 
  tuneGrid = hyper_grid,
  metric = "Accuracy" 
)

knn_fit$bestTune
finalModel<- knn_fit$finalModel
ggplot(knn_fit)
```

```{r}
defaultPred <- predict(knn_fit, default_test, type="prob")
plot(defaultPred$yes~default, data=default_test)

```


```{r}
set.seed(123)
str(credit)
credit.pca <- select(credit,-c('default'))
credit.pca <- as.data.frame(lapply(credit.pca,as.numeric))
credit.pca <- prcomp(credit.pca,scale. = TRUE, center = TRUE)
summary(credit.pca)
credit.pca1 <- data.frame(credit.pca$x[,1:14])
credit.pca1$default <- credit$default
# credit.scale$default <- credit$default
split <- initial_split(credit.pca1, prop = 0.7, 
                       strata = "default")
default_train  <- training(split)
default_test   <- testing(split)
knn_fit <- train(
  default ~ . , 
  data = default_train, 
  method = "knn", 
  trControl = cv, 
  tuneGrid = hyper_grid,
  metric = "Accuracy" 
)
knn_fit$bestTune
finalModel<- knn_fit$finalModel
ggplot(knn_fit)

```
```{r}
defaultPred <- predict(knn_fit, default_test, type="prob")
plot(defaultPred$yes~default, data=default_test)
```


## Task 4

### a

```{r}
library(TexMix)
```

```{r}
data("tractShp")
tractDf <- as.data.frame(tractShp)
```

```{r}
sapply(tractDf,is.factor)
```

```{r fig.height=12, fig.width=15}
library(ggplot2)
library(reshape2)
tractDf %>% is.na() %>%
  melt() %>%
  ggplot(aes(x = Var2,y = Var1,fill=value)) +
  geom_raster() +
  coord_flip()+
  scale_y_continuous(NULL, expand = c(0,0)) + 
  scale_fill_grey(name = '',labels = c("Present",'Missing'))+
  xlab('Observation') + 
  theme(axis.text.y = element_text(size = 4))
```

```{r}
tractDf %>% is.na() %>%
  apply(1,sum) %>% 
  table()

tractDf %>% is.na() %>%
  apply(2,sum) %>% 
  table()
```

```{r}
which(apply(is.na(tractDf), 2, sum)==110)
```


```{r}
library(recipes)
rec <- recipe(PCTB2010 ~ .,data = tractDf)
rec %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())
```

